<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß) + ‡πÅ‡∏ú‡∏á‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô ‚Ä¢ Firebase</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50: '#eff6ff',
              100: '#dbeafe',
              200: '#bfdbfe',
              300: '#93c5fd',
              400: '#60a5fa',
              500: '#3b82f6',
              600: '#2563eb',
              700: '#1d4ed8',
              800: '#1e40af',
              900: '#1e3a8a'
            }
          }
        }
      }
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    html, body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji'; }
    .container { max-width: 1100px; }
    .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <!-- Top Bar -->
  <header class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="container mx-auto px-4 py-3 flex items-center gap-3">
      <div class="flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 text-brand-600">
          <path d="M2 6a2 2 0 0 1 2-2h3l1-2h8l1 2h3a2 2 0 0 1 2 2v2H2V6Zm0 4h20v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-8Zm6 2v6h8v-6H8Z"/>
        </svg>
        <span class="font-semibold">‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ä‡πá‡∏≠‡∏õ</span>
        <span id="appVersion" class="ml-2 text-xs px-2 py-0.5 rounded-full bg-slate-100 text-slate-600"></span>
      </div>
      <div class="ml-auto flex items-center gap-2">
        <input id="searchInput" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." class="hidden md:block w-56 rounded-xl border border-slate-200 px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-brand-500/30">
        <button id="openCartBtn" class="relative rounded-xl px-3 py-1.5 border border-slate-200 hover:bg-slate-100">
          <span class="material-symbols-outlined">üõí</span>
          <span id="cartCount" class="absolute -top-2 -right-2 text-xs bg-brand-600 text-white w-5 h-5 rounded-full grid place-items-center">0</span>
        </button>
        <button id="adminBtn" class="rounded-xl px-3 py-1.5 border border-slate-200 hover:bg-slate-100">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</button>
        <button id="logoutBtn" class="hidden rounded-xl px-3 py-1.5 bg-slate-800 text-white hover:bg-slate-700">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="container mx-auto px-4 py-6 grid grid-cols-12 gap-6">
    <!-- Catalog -->
    <section class="col-span-12 lg:col-span-8" id="catalogSection">
      <h2 class="text-xl font-semibold mb-3">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
      <div id="productsGrid" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
      <div id="emptyCatalog" class="hidden border border-dashed rounded-xl p-6 text-center text-slate-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
    </section>

    <!-- Cart -->
    <aside class="col-span-12 lg:col-span-4">
      <div class="sticky top-[76px]">
        <div class="rounded-2xl border bg-white shadow-sm">
          <div class="p-4 border-b flex items-center justify-between">
            <h3 class="font-semibold">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
            <button id="clearCartBtn" class="text-sm text-slate-500 hover:text-slate-700">‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button>
          </div>
          <div id="cartItems" class="p-4 flex flex-col gap-3 max-h-[50vh] overflow-auto"></div>
          <div class="p-4 border-t">
            <div class="flex justify-between mb-3">
              <span>‡∏£‡∏ß‡∏°</span>
              <span id="cartTotal" class="font-semibold">‡∏ø0</span>
            </div>
            <button id="checkoutBtn" class="w-full rounded-xl bg-brand-600 text-white px-4 py-2 hover:bg-brand-700">‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
          </div>
        </div>
      </div>
    </aside>

    <!-- Admin Panel -->
    <section id="adminPanel" class="col-span-12 hidden">
      <div class="rounded-2xl border bg-white shadow-sm">
        <div class="p-4 border-b flex items-center justify-between">
          <h3 class="font-semibold">‡πÅ‡∏ú‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</h3>
          <div class="flex items-center gap-2">
            <span class="text-sm text-slate-500">‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÑ‡∏ü‡∏•‡πå</span>
            <input id="versionInput" class="w-28 rounded-lg border border-slate-200 px-2 py-1" placeholder="1.0.0" />
            <button id="updateVersionBtn" class="rounded-lg bg-slate-800 text-white px-3 py-1.5">‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï & ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
          </div>
        </div>
        <div class="p-4 grid gap-6 md:grid-cols-2">
          <form id="productForm" class="rounded-xl border p-4 grid gap-3">
            <h4 class="font-semibold">‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h4>
            <input type="hidden" id="productId" />
            <input id="nameInput" class="rounded-lg border border-slate-200 px-3 py-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" required />
            <textarea id="descInput" class="rounded-lg border border-slate-200 px-3 py-2" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î" rows="3"></textarea>
            <input id="priceInput" type="number" min="0" class="rounded-lg border border-slate-200 px-3 py-2" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)" required />
            <input id="stockInput" type="number" min="0" class="rounded-lg border border-slate-200 px-3 py-2" placeholder="‡∏™‡∏ï‡πá‡∏≠‡∏Å" required />
            <input id="imageInput" type="file" accept="image/*" class="rounded-lg border border-slate-200 px-3 py-2" />
            <div class="flex gap-2">
              <button class="rounded-lg bg-brand-600 text-white px-4 py-2" id="saveProductBtn" type="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
              <button class="rounded-lg border px-4 py-2" type="reset" id="resetProductBtn">‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
              <button class="rounded-lg border px-4 py-2 hidden" id="deleteProductBtn" type="button">‡∏•‡∏ö</button>
            </div>
          </form>

          <div class="rounded-xl border p-4">
            <h4 class="font-semibold mb-3">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h4>
            <div id="adminProducts" class="grid grid-cols-2 md:grid-cols-3 gap-3"></div>
            <div id="emptyAdmin" class="hidden text-sm text-slate-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Auth Modal -->
  <div id="authModal" class="hidden fixed inset-0 bg-black/40 z-50 items-center justify-center">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6">
      <h3 class="text-lg font-semibold mb-4">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</h3>
      <form id="authForm" class="grid gap-3">
        <input id="emailInput" type="email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" class="rounded-lg border border-slate-200 px-3 py-2" required />
        <input id="passInput" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="rounded-lg border border-slate-200 px-3 py-2" required />
        <button class="rounded-lg bg-slate-800 text-white px-4 py-2">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      </form>
      <p class="text-xs text-slate-500 mt-3">* ‡πÉ‡∏ä‡πâ Firebase Authentication (Email/Password)</p>
      <button id="closeAuthBtn" class="mt-4 text-sm text-slate-600 hover:text-slate-800">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden bg-slate-900 text-white px-4 py-2 rounded-xl shadow-lg"></div>

  <!-- Firebase SDK (v10 modular) -->
  <script type="module">
    /*********************************
     * 1) ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
     *********************************/
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js'
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js'
    import { getFirestore, collection, addDoc, doc, setDoc, getDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js'
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js'

    const firebaseConfig = {
     apiKey: "AIzaSyAmsiJelUN1V8C9mCC1Osy-uSZAuk3M7Lw",
  authDomain: "test-95403.firebaseapp.com",
  databaseURL: "https://test-95403-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "test-95403",
  storageBucket: "test-95403.firebasestorage.app",
  messagingSenderId: "30370027223",
  appId: "1:30370027223:web:be434cdf70770ea44f4292",
    }

    const app = initializeApp(firebaseConfig)
    const auth = getAuth(app)
    const db = getFirestore(app)
    const storage = getStorage(app)

    /*********************************
     * 2) Utilities
     *********************************/
    const fmt = new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB', maximumFractionDigits: 0 })
    const $ = (sel) => document.querySelector(sel)
    const $$ = (sel) => Array.from(document.querySelectorAll(sel))
    const toast = (msg) => { const t = $('#toast'); t.textContent = msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 1800) }

    /*********************************
     * 3) Realtime App Version -> ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï
     *    - ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô subscribe doc: meta/app { version: '1.0.0' }
     *    - ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï & ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ" ‡πÄ‡∏û‡∏∑‡πà‡∏≠ set ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
     *    - ‡∏ó‡∏∏‡∏Å‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
     *********************************/
    const metaDocRef = doc(db, 'meta', 'app')
    let currentVersion = localStorage.getItem('appVersion') || '1.0.0'
    const appVersionEl = $('#appVersion')
    appVersionEl.textContent = `v${currentVersion}`

    // subscribe ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô
    onSnapshot(metaDocRef, (snap) => {
      const data = snap.data() || { version: '1.0.0' }
      const v = data.version || '1.0.0'
      if (v !== currentVersion) {
        // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å GitHub/Hosting
        localStorage.setItem('appVersion', v)
        location.reload()
      }
    })

    // ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏ô‡πÅ‡∏ú‡∏á‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô
    $('#updateVersionBtn').addEventListener('click', async () => {
      const v = $('#versionInput').value.trim() || new Date().toISOString().slice(0,19).replace(/[:T]/g,'')
      await setDoc(metaDocRef, { version: v, updatedAt: serverTimestamp() }, { merge: true })
      toast('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏à‡∏∞‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥')
    })

    /*********************************
     * 4) Catalog (Firestore + Storage)
     *********************************/
    const productsCol = collection(db, 'products')

    const renderProductCard = (p) => {
      const div = document.createElement('div')
      div.className = 'rounded-xl border bg-white overflow-hidden shadow-sm hover:shadow'
      div.innerHTML = `
        <div class="aspect-square bg-slate-100 overflow-hidden">
          <img src="${p.imageURL || 'https://dummyimage.com/600x600/eee/aaa&text=No+Image'}" alt="${p.name}" class="w-full h-full object-cover">
        </div>
        <div class="p-3 grid gap-1">
          <div class="font-semibold line-clamp-2">${p.name}</div>
          <div class="text-sm text-slate-500 line-clamp-2">${p.desc || ''}</div>
          <div class="flex items-center justify-between mt-2">
            <span class="font-semibold">${fmt.format(p.price || 0)}</span>
            <button data-id="${p.id}" class="addToCart rounded-lg bg-brand-600 text-white px-3 py-1.5 disabled:opacity-50" ${p.stock>0?'':'disabled'}>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button>
          </div>
          <div class="text-xs text-slate-500">‡∏™‡∏ï‡πá‡∏≠‡∏Å: ${p.stock ?? 0}</div>
        </div>`
      return div
    }

    const productsGrid = $('#productsGrid')
    const emptyCatalog = $('#emptyCatalog')

    const qProducts = query(productsCol, orderBy('createdAt','desc'))
    onSnapshot(qProducts, (snap) => {
      productsGrid.innerHTML = ''
      if (snap.empty) { emptyCatalog.classList.remove('hidden'); return }
      emptyCatalog.classList.add('hidden')
      snap.forEach(docu => {
        const p = { id: docu.id, ...docu.data() }
        productsGrid.appendChild(renderProductCard(p))
      })
    })

    /*********************************
     * 5) Simple Cart (LocalStorage)
     *********************************/
    const cartKey = 'cartItems'
    const getCart = () => JSON.parse(localStorage.getItem(cartKey) || '[]')
    const setCart = (items) => { localStorage.setItem(cartKey, JSON.stringify(items)); renderCart() }

    const addToCart = (item) => {
      const cart = getCart()
      const idx = cart.findIndex(i => i.id === item.id)
      if (idx >= 0) cart[idx].qty += 1
      else cart.push({ ...item, qty: 1 })
      setCart(cart)
      toast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß')
    }

    const renderCart = () => {
      const items = getCart()
      const cont = $('#cartItems')
      cont.innerHTML = ''
      if (!items.length) cont.innerHTML = '<div class="text-sm text-slate-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</div>'
      let total = 0
      items.forEach(it => {
        total += (it.price || 0) * it.qty
        const row = document.createElement('div')
        row.className = 'flex gap-3'
        row.innerHTML = `
          <img src="${it.imageURL || 'https://dummyimage.com/64x64/eee/aaa'}" class="w-16 h-16 rounded-lg object-cover"/>
          <div class="flex-1">
            <div class="font-medium">${it.name}</div>
            <div class="text-sm text-slate-500">${fmt.format(it.price)} ‚Ä¢ x${it.qty}</div>
            <div class="mt-2 flex gap-2 text-sm">
              <button data-id="${it.id}" class="qtyDec px-2 border rounded">-</button>
              <button data-id="${it.id}" class="qtyInc px-2 border rounded">+</button>
              <button data-id="${it.id}" class="qtyDel px-2 border rounded">‡∏•‡∏ö</button>
            </div>
          </div>`
        cont.appendChild(row)
      })
      $('#cartTotal').textContent = fmt.format(total)
      $('#cartCount').textContent = items.reduce((a,b)=>a+b.qty,0)
    }

    renderCart()

    document.body.addEventListener('click', (e) => {
      const btn = e.target.closest('button')
      if (!btn) return

      if (btn.classList.contains('addToCart')) {
        const id = btn.dataset.id
        // ‡∏î‡∏∂‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å DOM card
        const card = btn.closest('.border')
        const name = card.querySelector('.font-semibold').textContent
        const price = Number(card.querySelector('.font-semibold + .text-sm')?.textContent) // not reliable
        // ‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å attributes ‡∏ó‡∏µ‡πà‡∏ù‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢ ‡∏à‡∏∂‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å productsGrid snapshot ‡πÅ‡∏ó‡∏ô
        // ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ ‡πÄ‡∏£‡∏≤‡∏à‡∏∞ query Firestore ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡∏¥‡πâ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        addSingleProductToCart(id)
      }

      if (btn.id === 'clearCartBtn') setCart([])

      if (btn.classList.contains('qtyDec')) { const id = btn.dataset.id; const cart = getCart(); const i = cart.findIndex(x=>x.id===id); if(i>=0){cart[i].qty=Math.max(1,cart[i].qty-1); setCart(cart)} }
      if (btn.classList.contains('qtyInc')) { const id = btn.dataset.id; const cart = getCart(); const i = cart.findIndex(x=>x.id===id); if(i>=0){cart[i].qty+=1; setCart(cart)} }
      if (btn.classList.contains('qtyDel')) { const id = btn.dataset.id; const cart = getCart().filter(x=>x.id!==id); setCart(cart) }

      if (btn.id === 'adminBtn') { toggleAdmin(true) }
      if (btn.id === 'closeAuthBtn') { toggleAuth(false) }
      if (btn.id === 'logoutBtn') { signOut(auth) }
    })

    async function addSingleProductToCart(id){
      const ref = doc(db, 'products', id)
      const d = await getDoc(ref)
      if (d.exists()) {
        const p = { id: d.id, ...d.data() }
        addToCart({ id: p.id, name: p.name, price: p.price || 0, imageURL: p.imageURL || '' })
      }
    }

    $('#checkoutBtn').addEventListener('click', async () => {
      const items = getCart()
      if (!items.length) return toast('‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á')
      // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏•‡∏á Firestore (‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏£‡∏¥‡∏á)
      const order = { items, total: items.reduce((s,i)=>s+i.price*i.qty,0), createdAt: serverTimestamp(), status: 'pending' }
      await addDoc(collection(db, 'orders'), order)
      setCart([])
      toast('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)')
    })

    /*********************************
     * 6) Admin ‚Äî Auth + CRUD
     *********************************/
    const adminPanel = $('#adminPanel')
    const authModal = $('#authModal')

    function toggleAdmin(open){
      if (auth.currentUser) adminPanel.classList.toggle('hidden', !open)
      else toggleAuth(true)
    }
    function toggleAuth(open){ authModal.classList.toggle('hidden', !open); authModal.classList.toggle('flex', open) }

    $('#authForm').addEventListener('submit', async (e) => {
      e.preventDefault()
      const email = $('#emailInput').value.trim()
      const pass = $('#passInput').value.trim()
      try {
        await signInWithEmailAndPassword(auth, email, pass)
      } catch (err) {
        console.error(err)
        toast('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à')
      }
    })

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        $('#logoutBtn').classList.remove('hidden')
        toggleAuth(false)
        adminPanel.classList.remove('hidden')
        $('#versionInput').value = localStorage.getItem('appVersion') || '1.0.0'
      } else {
        $('#logoutBtn').classList.add('hidden')
        adminPanel.classList.add('hidden')
      }
    })

    const adminProducts = $('#adminProducts')
    onSnapshot(qProducts, (snap) => {
      adminProducts.innerHTML = ''
      if (snap.empty) $('#emptyAdmin').classList.remove('hidden')
      else $('#emptyAdmin').classList.add('hidden')
      snap.forEach(docu => {
        const p = { id: docu.id, ...docu.data() }
        const card = document.createElement('div')
        card.className = 'rounded-xl border overflow-hidden bg-white'
        card.innerHTML = `
          <img src="${p.imageURL || 'https://dummyimage.com/600x600/eee/aaa'}" class="w-full aspect-square object-cover"/>
          <div class="p-2 text-sm grid gap-1">
            <div class="font-medium">${p.name}</div>
            <div>${fmt.format(p.price || 0)} ‚Ä¢ ‡∏™‡∏ï‡πá‡∏≠‡∏Å ${p.stock ?? 0}</div>
            <div class="flex gap-2 mt-1">
              <button data-id="${p.id}" class="editProd border rounded px-2 py-1">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
              <button data-id="${p.id}" class="delProd border rounded px-2 py-1">‡∏•‡∏ö</button>
            </div>
          </div>`
        adminProducts.appendChild(card)
      })
    })

    adminProducts.addEventListener('click', async (e) => {
      const b = e.target.closest('button')
      if (!b) return
      const id = b.dataset.id
      if (b.classList.contains('editProd')) {
        const d = await getDoc(doc(db,'products',id))
        if (d.exists()) {
          const p = d.data()
          $('#productId').value = id
          $('#nameInput').value = p.name || ''
          $('#descInput').value = p.desc || ''
          $('#priceInput').value = p.price || 0
          $('#stockInput').value = p.stock || 0
          $('#deleteProductBtn').classList.remove('hidden')
          window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' })
        }
      }
      if (b.classList.contains('delProd')) {
        if (confirm('‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ?')) {
          const d = await getDoc(doc(db,'products',id))
          const p = d.data() || {}
          if (p.imagePath) {
            try { await deleteObject(sRef(storage, p.imagePath)) } catch {}
          }
          await deleteDoc(doc(db,'products',id))
          toast('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß')
        }
      }
    })

    $('#productForm').addEventListener('submit', async (e) => {
      e.preventDefault()
      const id = $('#productId').value
      const name = $('#nameInput').value.trim()
      const desc = $('#descInput').value.trim()
      const price = Number($('#priceInput').value)
      const stock = Number($('#stockInput').value)
      let imageURL = ''
      let imagePath = ''

      const file = $('#imageInput').files[0]
      if (file) {
        const path = `products/${Date.now()}_${file.name}`
        const ref = sRef(storage, path)
        await uploadBytes(ref, file)
        imageURL = await getDownloadURL(ref)
        imagePath = path
      }

      if (id) {
        const ref = doc(db,'products',id)
        const before = await getDoc(ref)
        const prev = before.data() || {}
        await updateDoc(ref, { name, desc, price, stock, ...(imageURL ? { imageURL, imagePath } : {}) })
        if (imageURL && prev.imagePath) { try { await deleteObject(sRef(storage, prev.imagePath)) } catch {} }
        toast('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß')
      } else {
        await addDoc(productsCol, { name, desc, price, stock, imageURL, imagePath, createdAt: serverTimestamp() })
        toast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß')
      }

      e.target.reset()
      $('#productId').value = ''
      $('#deleteProductBtn').classList.add('hidden')
    })

    $('#resetProductBtn').addEventListener('click', ()=>{
      $('#productId').value = ''
      $('#deleteProductBtn').classList.add('hidden')
    })

    $('#deleteProductBtn').addEventListener('click', async ()=>{
      const id = $('#productId').value
      if (!id) return
      if (!confirm('‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ?')) return
      const d = await getDoc(doc(db,'products',id))
      const p = d.data() || {}
      if (p.imagePath) { try { await deleteObject(sRef(storage, p.imagePath)) } catch {} }
      await deleteDoc(doc(db,'products',id))
      toast('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß')
      $('#productForm').reset()
      $('#productId').value = ''
      $('#deleteProductBtn').classList.add('hidden')
    })

    /*********************************
     * 7) Search (client-side filter)
     *********************************/
    $('#searchInput').addEventListener('input', (e)=>{
      const q = e.target.value.toLowerCase()
      $$('#productsGrid > div').forEach(card => {
        const name = card.querySelector('.font-semibold').textContent.toLowerCase()
        const desc = (card.querySelector('.text-sm.text-slate-500')?.textContent || '').toLowerCase()
        card.classList.toggle('hidden', !(name.includes(q) || desc.includes(q)))
      })
    })

    /*********************************
     * 8) UX bits
     *********************************/
    $('#openCartBtn').addEventListener('click', ()=>{
      document.querySelector('aside').scrollIntoView({ behavior: 'smooth', block: 'start' })
    })

  </script>

  <!-- Helpful notes / Deployment & Security (comments only)
  1) ‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà Firebase Console:
     - Authentication: Email/Password (‡∏™‡∏£‡πâ‡∏≤‡∏á user ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•)
     - Firestore Database
     - Storage

  2) ‡∏ï‡∏±‡πâ‡∏á‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤ Firestore Rules (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢):
     rules_version = '2';
     service cloud.firestore {
       match /databases/{database}/documents {
         match /products/{id} { allow read: if true; allow write: if request.auth != null; }
         match /orders/{id}   { allow read, write: if true; } // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡πà‡∏≤‡∏ô‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞ (‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á)
         match /meta/{doc}    { allow read: if true; allow write: if request.auth != null; }
       }
     }

     ‡πÅ‡∏•‡∏∞ Storage Rules:
     rules_version = '2';
     service firebase.storage { match /b/{bucket}/o {
       match /products/{allPaths=**} { allow read: if true; allow write: if request.auth != null; }
     } }

  3) Auto-Reload ‡∏ó‡∏∏‡∏Å‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï:
     - ‡∏ó‡∏µ‡πà‡πÅ‡∏ú‡∏á‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï & ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ" -> ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤ meta/app.version
     - ‡∏ó‡∏∏‡∏Å client onSnapshot(meta/app) ‡∏à‡∏∞ location.reload() ‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å GitHub Pages / Firebase Hosting
     - ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏ä‡πâ Cache Busting ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö CDN/Hosting ‡∏î‡πâ‡∏ß‡∏¢ (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏û‡∏¥‡πà‡∏° query ?v=‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡πâ‡πÑ‡∏ü‡∏•‡πå asset ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå)

  4) ‡∏≠‡∏±‡∏û‡∏Ç‡∏∂‡πâ‡∏ô GitHub:
     - ‡∏™‡∏£‡πâ‡∏≤‡∏á repo ‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô index.html ‡∏ó‡∏µ‡πà root
     - ‡πÄ‡∏õ‡∏¥‡∏î GitHub Pages (Branch: main, Folder: root)
     - ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ Firebase Hosting: firebase init hosting -> deploy

  5) ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÅ‡∏≠‡∏õ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡πà‡∏≤‡∏¢ ‡∏´‡∏≤‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á ‡∏Ñ‡∏ß‡∏£‡πÅ‡∏¢‡∏Å‡πÑ‡∏ü‡∏•‡πå/‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå, ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠, ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô ‡∏Ø‡∏•‡∏Ø
  -->
</body>
</html>
